# Q. 넷플릭스 홈에서는 어떻게 딜레이 없이 수 백개의 영상들을 제공할 수 있을까?
>캐싱을 사용한다고 가정해도 홈에서 제공하는 수백개가 넘는 영상들을 전부 캐싱할 수는 없을 것<br>
그렇다면 넷플릭스는 어떻게 딜레이 없이 수백개의 영상을 제공하는 걸까?

---

# A. 넷플릭스와 같은 대규모 영상 스트리밍 서비스의 경우 단순 영상 캐싱과 함께 여러 레이어의 최적화가 합쳐져 사용자에게 서비스를 제공한다.

### 대규모 영상 스트리밍 서비스에서 제공하는 다양한 레이어<br>
## 최적화
> ### CDN
> 영상을 중앙 서버에서만 제공할 경우 레이턴시가 증가, **사용자와 가장 가까운 서버**에서 데이터 제공 <br>
> 본편 스트리밍은 넷플릭스 전용 CDN인 Open Connect 가 담당 <br>
> 사용자와 가까운 OCA까지 콘텐츠를 **야간 채움**으로 미리 분산시켜 두고, 재생 시점에는 클라이언트 특성과 네트워크 조건을 보고 가장 가까운/건강한 캐시로 바로 보냄 <br>
> 만약 대한민국 서버를 사용하는 사용자가 넷플릭스에 접속 시, 넷플릭스 본사가 있는 서버(미국)가 아닌 사용자와 가장 가까운 서버(대한민국)에 사용자가 자주 보는 데이터들을 미리 캐싱해놓고, 데이터를 제공하는 방식 <br>

**야간 채움**: 사용자가 영상을 요청하기도 전에, 미리 OCA(엣지 캐시 서버)에 콘텐츠를 채워 넣는 작업
- **장점**
  - **지연 최소화**: 사용자가 요청했을 때 이미 가까운 OCA에 있으므로 즉시 시작 가능
  - **네트워크 비용 절감**: 국제망/백본망을 통한 실시간 대규모 전송을 피함
  - **대규모 트래픽 분산**: 피크 타임 저녁 네트워크 혼잡 완화
  - **서비스 안정성**: 갑자기 특정 콘텐츠가 폭발적 인기를 끌어도 이미 캐시되어 있음

> ### 비디오 스트리밍 방식 (HLS/DASH)
> 영상을 하나의 큰 파일로 전송하는 것이 아닌, 수 초 단위의 **작은 청크 단위로 나누어 전송** <br>
> 사용자가 재생을 시작하게 되면 초반 청크 일부만 다운로드 받아 바로 스트리밍을 시작 <br>
> 나머지 청크들에 대해서는 백그라운드에서 지속적으로 다운로드 및 버퍼링을 적용해 끊임없는 스트리밍 제공 <br>
> 1시간짜리 영화가 있다면 한 번에 1시간짜리 전체 데이터를 전송하는게 아닌, 5초 단위로 쪼개어 데이터를 전송하고, 플랫폼에서는 사용자가 영상을 시청하는 동안 백그라운드에서 나머지 청크들을 지속적으로 다운로드하는 방식

> ### ABR (Adaptive Bitrate Streaming)
> 사용자의 네트워크 속도에 맞추어 화질을 조정하는 기술 적용 <br>
> ABR을 통해 사용자에게 끊기지 않는 스트리밍 서비스를 제공할 수 있음 <br>
> 유튜브를 시청할 때 네트워크 환경이 좋지 않으면 360p로 화질을 낮추어 영상을 재생하다가 환경이 좋아지면 다시 720p 등으로 올리는 방식  

> ### 메타데이터 및 썸네일 로딩
> 홈 화면의 각 타일은 제목/설명/등급 같은 메타데이터와, 여러 비율(16:9, 2:3 등)로 미리 만들어 둔 아트워크 이미지만 제공 <br>
> 이 이미지들은 차세대 포맷(AVIF, WebP)으로 제공되어, 품질을 유지하면서 용량을 크게 줄이는 게 가능해짐<br>
> 따라서 홈에서 보여지는 정보들은 영상 스트리밍이 아닌 이미지 + 데이터 정보 <br>
> 즉, 사용자가 실제 영상 화면에 접근하기 전까지 영상 데이터를 로딩하지 않고 메타데이터 및 썸네일만 로딩 -> 질문의 해답!

## 실제 서비스 제공 프로세스
### 0. 앱 / 웹 진입
> **DNS & 라우팅**
> 각 주제에 맞는 여러 도메인에 요청 <br>
> 넷플릭스 화면에서 보이는 카탈로그, 메타데이터 등등 주제에 맞는 도메인에 요청 <br>
> 사용자가 서비스를 이용하는 위치와 가장 가까운 엣지 서버로 연결

> **TLS 세션 수립 및 재사용**
> TLS 3way handshake 시도 (재방문일 경우 세션 재사용) <br>
> HTTP/2 또는 HTTP/3로 연결 수립

> **메타 데이터 요청**

> **썸네일, 아트워크 로딩 (지연 로딩)** <br>
> 홈 화면에서 보여줄 전체 데이터를 한 번에 로딩 X <br>
> 사용자의 홈 화면에서 보이는 데이터 위주로 데이터 요청 <br>
> 사용자가 스크롤 시 추가적으로 데이터 요청
